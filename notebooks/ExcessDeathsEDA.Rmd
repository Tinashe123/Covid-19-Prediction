---
title: "RSA Covid 19 and Excess Fatality Exploratory Data Analysis"
author: "Graeme Lubbe"
date: '2022-03-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

## Set-up and reading data
Here the global environment is cleared, the necessary packages are loaded and the working directory is set. Additionally, the data used in this analysis is read. 

```{r set 2}
rm(list = ls())

#required libraries
library(dplyr)
library(readr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(broom)
library(purrr)

## Setting the working directory
setwd("C:/Users/User/Documents/University/Masters/2nd Year/MIT808/Project")

## Reading in excess dates data from obtained from https://www.samrc.ac.za/reports/report-weekly-deaths-south-africa
excess_deaths <- read.csv("./data/ExcessDeaths.csv", stringsAsFactors = F, sep = ";")

## reading cumulative deaths
cumtive_deaths <- read.csv("./data/covid19za_provincial_cumulative_timeline_deaths.csv", stringsAsFactors = F)
```

## Cleaning Fatality Data 

Next the date variables are changed to date objects and column names for the two fatality data sets are changed to match each other. The data frame shape of the two are adjusted to match eachother to allow the combination of the two frames. An indicator for the week and year is created, as the excess mortality is only reported on a weekly basis, and this will allow for direct comparison. Next an indicator is created to distinguish excess mortality numbers from reported covid 19 fatalities. Finaly the two data frame are combined

```{r pressure, echo=FALSE}
## Back calculating deaths per day and adding epi week for correlation anlysis with excess deaths
deaths <- cumtive_deaths %>% 
  mutate(across(.cols = EC:total, ~ifelse(YYYYMMDD == 20200327, .,  (.) - dplyr::lag(.))),
         date = dmy(date),
         year = year(date),
         epi_week = epiweek(date),
         indicator = "Covid 19 Deaths") %>% 
  select(date, year, epi_week, EC:WC, RSA = total, indicator)
  

## Changing compatibility between two death data frames
excess_deaths_clean <- excess_deaths %>%
  rename(date = X) %>% 
  mutate(date = dmy(date),
         epi_week = epiweek(date),
         year = year(date),
         indicator = "Excess Deaths") %>% 
  select(date, year, epi_week, EC, FS, GP = GT, KZN, LP = LM, MP:WC, RSA, indicator)

combined_df <- rbind(deaths, excess_deaths_clean) 

head(combined_df)
```

## Analysis of Excess Mortality

First the weekly total covid related fatalities and excess mortalities are plotted over time per province and for South Africa. 

```{r time plot}
## Plot the excess mortality and actual deaths per week over time to compare trends
combined_df %>% 
  group_by(epi_week, year, indicator) %>% 
  summarise(date = min(date),
            across(.cols = EC:RSA, ~sum(., na.rm = T))) %>% 
  pivot_longer(cols = EC:RSA, names_to = "Province", values_to = "Deaths") %>% 
  ggplot(aes(x = date, y = Deaths, colour = indicator))+
  geom_line()+
  facet_wrap(.~Province, scales = "free_y")+ theme(axis.text.x = element_text(angle = 90))
```

And then the two are plotted against each other.

```{r versus}
## Plot correlation between the two
combined_df %>% 
  group_by(epi_week, year, indicator) %>% 
  summarise(date = min(date),
            across(.cols = EC:RSA, ~sum(., na.rm = T))) %>% 
  pivot_longer(cols = EC:RSA, names_to = "Province", values_to = "Deaths") %>% 
  pivot_wider(names_from = indicator, values_from = Deaths) %>% 
  ggplot(aes(x = `Covid 19 Deaths`, y = `Excess Deaths`))+
  geom_point(shape = 1)+
  facet_wrap(.~Province, scales = "free")+
  geom_smooth(method = "lm", se = F, colour = "black")
```

And finally, a nested regression is performed per province and for the entire country to determine the strength of the correlation and the degree of under reporting. A good correlation shows that the covid 19 fatalities corrlates well with excess fatalities, while a higher estimate indicates either inaccurate death predictions, or under reporting of covid 19 related fatalities.

```{r nested model, message=F}
lin_reg <- combined_df %>% 
  group_by(epi_week, year, indicator) %>% 
  summarise(date = min(date),
            across(.cols = EC:RSA, ~sum(., na.rm = T))) %>% 
  pivot_longer(cols = EC:RSA, names_to = "Province", values_to = "Deaths") %>% 
  pivot_wider(names_from = indicator, values_from = Deaths) %>% 
  ungroup() %>%
  select(-c(epi_week, year)) %>% 
  group_by(Province) %>% 
  drop_na() %>% 
  nest() %>% 
  mutate(
    fit = map(data, ~ lm(`Covid 19 Deaths` ~ `Excess Deaths` - 1, data = .x)),
    tidied = map(fit, tidy),
    glanced = map(fit, glance)
  ) 

```

```{r glance}
lin_reg %>% 
  unnest(glanced) %>% 
  select(Province, r.squared)
```


```{r tidy}
lin_reg %>% 
  unnest(tidied) %>% 
  select(-c(data, fit, glanced, term))
```

